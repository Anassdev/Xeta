xetaChat={actualWindowTitle:$(document).attr("title"),lastRefresh:Math.round((new Date).getTime()/1e3),notice:null,lastMessage:{id:null,time:null,text:null},settings:{autoScroll:1,maxMessages:25,maxRetrying:5,floodRule:3e3,spamRule:95,messageMaxLength:400,smiliesAdded:!1,smiliesShowed:!1,locale:"en",refreshTime:null,urlRefresh:null,urlDeleteMessage:null,urlGetNotice:null},domIDs:{chatboxContent:"chatboxContent",inputMessage:"chatboxMessage",buttonSend:"chatboxSend",userCounter:"usersCount",notice:"chatboxNotice",smiliesBox:"smiliesBox",usersOnline:"chatboxOnline",deleteMessage:"chatboxDeleteMessage"},dom:null,user:{id:null,groupId:null,groupName:null,isConnected:null},lang:null,smileys:{crying:{replace:'<i class="xeta-smiley icon-crying" data-name="crying" data-toggle="tooltip" title="cry"></i>',smiley:":cry:"},frustrated:{replace:'<i class="xeta-smiley icon-frustrated" data-name="frustrated" data-toggle="tooltip" title="frustrated"></i>',smiley:":frustrated:"},sleepy:{replace:'<i class="xeta-smiley icon-sleepy" data-name="sleepy" data-toggle="tooltip" title="sleepy"></i>',smiley:":sleepy:"},hipster:{replace:'<i class="xeta-smiley icon-hipster" data-name="hipster" data-toggle="tooltip" title="hipster"></i>',smiley:":hipster:"},heartbroken:{replace:'<i class="xeta-smiley icon-heart-broken text-danger" data-name="heartbroken" data-toggle="tooltip" title="heartbroken"></i>',smiley:":heartbroken:"},heart:{replace:'<i class="xeta-smiley icon-heart text-danger" data-name="heart" data-toggle="tooltip" title="heart"></i>',smiley:":heart:"},boy:{replace:'<i class="xeta-smiley icon-boy text-info" data-name="boy" data-toggle="tooltip" title="boy"></i>',smiley:":boy:"},girl:{replace:'<i class="xeta-smiley icon-girl text-pink" data-name="girl" data-toggle="tooltip" title="girl"></i>',smiley:":girl:"},cool:{replace:'<i class="xeta-smiley icon-cool" data-name="cool" data-toggle="tooltip" title="cool"></i>',smiley:":cool:"},evil:{replace:'<i class="xeta-smiley icon-evil" data-name="evil" data-toggle="tooltip" title="evil"></i>',smiley:":evil:"},un:{replace:'<i class="xeta-smiley icon-un" data-name="un" data-toggle="tooltip" title="un"></i>',smiley:":un:"},ghost:{replace:'<i class="xeta-smiley icon-ghost" data-name="ghost" data-toggle="tooltip" title="ghost"></i>',smiley:":ghost:"},pacman:{replace:'<i class="xeta-smiley icon-pacman" data-name="pacman" data-toggle="tooltip" title="pacman"></i>',smiley:":pacman:"},medal:{replace:'<i class="xeta-smiley icon-medal" data-name="medal" data-toggle="tooltip" title="medal"></i>',smiley:":medal:"},medal2:{replace:'<i class="xeta-smiley icon-medal2" data-name="medal2" data-toggle="tooltip" title="medal2"></i>',smiley:":medal2:"},superman:{replace:'<i class="xeta-smiley icon-superman" data-name="superman" data-toggle="tooltip" title="superman"></i>',smiley:":superman:"},pokeball:{replace:'<i class="xeta-smiley icon-pokeball" data-name="pokeball" data-toggle="tooltip" title="pokeball"></i>',smiley:":pokeball:"},toad:{replace:'<i class="xeta-smiley icon-toad" data-name="toad" data-toggle="tooltip" title="toad"></i>',smiley:":toad:"},happy:{replace:'<i class="xeta-smiley icon-happy" data-name="happy" data-toggle="tooltip" title=":D"></i>',smiley:":D"},baffled:{replace:'<i class="xeta-smiley icon-baffled" data-name="baffled" data-toggle="tooltip" title="o.o"></i>',smiley:"o.o"},smile:{replace:'<i class="xeta-smiley icon-smile" data-name="smile" data-toggle="tooltip" title=":)"></i>',smiley:":)"},sad:{replace:'<i class="xeta-smiley icon-sad" data-name="sad" data-toggle="tooltip" title=":("></i>',smiley:":("},tongue:{replace:'<i class="xeta-smiley icon-tongue" data-name="tongue" data-toggle="tooltip" title=":P"></i>',smiley:":P"},wink:{replace:'<i class="xeta-smiley icon-wink" data-name="wink" data-toggle="tooltip" title=";)"></i>',smiley:";)"},grin:{replace:'<i class="xeta-smiley icon-grin" data-name="grin" data-toggle="tooltip" title="xD"></i>',smiley:"xD"},confused:{replace:'<i class="xeta-smiley icon-confused" data-name="confused" data-toggle="tooltip" title=":S"></i>',smiley:":S"},angry:{replace:'<i class="xeta-smiley icon-angry" data-name="angry" data-toggle="tooltip" title=":@"></i>',smiley:":@"},shocked:{replace:'<i class="xeta-smiley icon-shocked" data-name="shocked" data-toggle="tooltip" title=":O"></i>',smiley:":O"},neutral:{replace:'<i class="xeta-smiley icon-neutral" data-name="neutral" data-toggle="tooltip" title=":|"></i>',smiley:":|"}},init:function(e,t){this.lang=t,this.settings=this._mergeObjects(this.settings,e),this._initializeDocumentNodes(),this._updateChat()},_initializeDocumentNodes:function(){this.dom={};for(var e in this.domIDs)this.dom[e]=document.getElementById(this.domIDs[e])},_updateChat:function(e){e="undefined"!=typeof e?e:0,$.ajax({type:"GET",url:this.settings.urlRefresh,dataType:"xml",data:{lastMessageId:null!==this.lastMessage.id?this.lastMessage.id:0},success:function(e){xetaChat._handleXML(e)},error:function(){xetaChat._notify("danger",xetaChat.lang.getServerResponse),e++}}),(0===e||0!==e&&e<this.settings.maxRetrying)&&setTimeout(function(){xetaChat._updateChat(e)},this.settings.refreshTime)},deleteMessage:function(e){return $.ajax({type:"POST",url:this.settings.urlDeleteMessage,data:{id:e},dataType:"json",success:function(t){t.error===!1?(xetaChat._getMessageNode(e)&&$("#chatboxMessage-"+e).remove(),xetaChat._notify("primary",t.message)):xetaChat._notify("danger",t.message)},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToDeleteMessage)}}),!0},addSmiliesToBox:function(){if(this.settings.smiliesAdded===!1){var e="";for(var t in this.smileys)e+=this.smileys[t].replace;$(this.dom.smiliesBox).html(e),$(this.dom.smiliesBox).fadeIn("slow"),this.settings.smiliesAdded=!0,this.settings.smiliesShowed=!0}else this.settings.smiliesShowed===!0?($(this.dom.smiliesBox).fadeOut("slow"),this.settings.smiliesShowed=!1):($(this.dom.smiliesBox).fadeIn("slow"),this.settings.smiliesShowed=!0)},sendShout:function(){if(this._disableInputs(!0),this.user.isConnected===!1)return void this._notify("danger",this.lang.userNotConnected);var e=$(this.dom.inputMessage).val().trim();return this._handleShoutRules(e)!==!1?($.ajax({type:"POST",url:$(this.dom.buttonSend).attr("data-url"),dataType:"json",data:{message:e},success:function(t){t.error!==!1||"undefined"!=typeof t.hasCmd&&t.hasCmd!==!1||"undefined"!=typeof t.message?"undefined"!=typeof t.hasCmd&&t.hasCmd===!0&&t.error===!1?xetaChat._handleCommands(t):t.error===!1&&t.hasCmd===!1&&"undefined"!=typeof t.message?xetaChat._notify("danger",t.message):xetaChat._notify("danger",t.message):($(xetaChat.dom.inputMessage).val(""),xetaChat.lastMessage.text=e,xetaChat.lastMessage.time=(new Date).getTime()),xetaChat._disableInputs(!1),$(xetaChat.dom.inputMessage).focus()},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToShout),xetaChat._disableInputs(!1)}}),!0):void 0},_addMessageToChatList:function(e,t,a,s,i,n,l,o){this._getMessageNode(l)||$(this.dom.chatboxContent).prepend($("<li>").attr({id:"chatboxMessage-"+l,"data-userid":t,"data-messageid":l}).append($("<div>").addClass("dropdown actions").append($("<a>").addClass("popupControl").attr({href:"#","data-toggle":"dropdown","aria-expanded":"false","aria-haspopup":"true"}).append($("<span>").addClass("caret"))).append($("<ul>").addClass("dropdown-menu").attr({role:"menu"}).append($("<li>").append($("<a>").attr({id:this.domIDs.deleteMessage,href:"#",role:"menuitem","data-id":l}).text("Delete"))))).append($("<span>").addClass("dateTime").text(" - ").prepend($("<time>").addClass("DateTime").attr("data-livestamp",e).text(this.lang.AFewSecondsAgo))).append($("<span>").append($("<span>").addClass("chatboxTag").attr({title:"Reply","data-toggle":"tooltip","data-placement":"left",onclick:"var member = $(this).parent().children('a.username').text(); $('input#chatboxMessage').val($('#chatboxMessage').focus().val() + '@' + member.trim() + ' ');"}).append($("<i>").addClass("fa fa-reply"))).append($("<a>").addClass("username").attr({style:s,href:i}).text(" "+a)).append(": ").append($("<div>").addClass("chatboxMessageText").html(this._formatText(o)))))},_handleXML:function(e){this._handleInfos(e),this._handleOnlineUsers(e),this._handleChatMessages(e)},_handleInfos:function(e){$(e).find("info").each(function(t){var a=$(e).find("info")[t].childNodes[1].nodeName,s=$(e).find("info")[t].childNodes[1].textContent;xetaChat._handleInfo(a,s)})},_handleInfo:function(e,t){switch(e){case"usersCounter":this._updateUsersCounter(t);break;case"notice":t!==this.notice&&(this._updateNotice(t),this.notice=t);break;case"isConnected":var a=this._getBool(t);a===!1&&this._disableInputs(!0),this.user.isConnected=a}},_handleOnlineUsers:function(e){if(e.getElementsByTagName("user")[0].childNodes.length){$(".panel-chat-online").is(":visible")===!1&&$(".panel-chat-online").show(),$(this.dom.usersOnline).html("");var t=$("id",$(e).find("user")[$(e).find("user").length-1]).text();$(e).find("user").each(function(){xetaChat._handleUser($("id",this).text(),$("user_id",this).text(),$("username",this).text(),$("group_id",this).text(),$("css",this).text(),$("is_banned",this).text(),$("created",this).text(),$("link",this).text(),t)})}else $(".panel-chat-online").hide()},_handleUser:function(e,t,a,s,i,n,l,o,d){if(!this._getUserNode(t)){var r=" ";d!=e&&(r=", "),$(this.dom.usersOnline).append($("<li>").attr({id:"chatboxUser-"+t}).append($("<a>").addClass("username").attr({style:i,href:o}).text(a)).append(r))}},_handleChatMessages:function(e){e.getElementsByTagName("message").length&&($(e).find("message").each(function(){xetaChat._addMessageToChatList($("created",this).text(),$("user_id",this).text(),$("username",this).text(),$("css",this).text(),$("link",this).text(),$("group_id",this).text(),$("id",this).text(),$("text",this).text(),$("command",this).text())}),this._updateChatlistView(),this.lastMessage.id=$("id",$(e).find("message")[$(e).find("message").length-1]).text())},_updateChatlistView:function(){if(this.dom.chatboxContent.childNodes&&this.settings.maxMessages)for(;this.dom.chatboxContent.childNodes.length>this.settings.maxMessages;)this.dom.chatboxContent.removeChild(this.dom.chatboxContent.lastChild);this.settings.autoScroll&&(this.dom.chatboxContent.scrollTop=this.dom.chatboxContent.scrollHeight)},_handleCommands:function(e){switch(e.command){case"prune":this._handleCommandPrune(e),$(this.dom.inputMessage).val("");break;case"ban":$(this.dom.inputMessage).val("");break;case"unban":$(this.dom.inputMessage).val("")}},_handleCommandPrune:function(e){if(this.dom.chatboxContent.childNodes&&e.lastMessageId)for(;xetaChat.dom.chatboxContent.childNodes[0]&&xetaChat.dom.chatboxContent.childNodes[0].id!="chatboxMessage-"+e.lastMessageId;)this.dom.chatboxContent.removeChild(this.dom.chatboxContent.lastChild)},_handleShoutRules:function(e){if(null!==this.lastMessage.time&&this.lastMessage.time+this.settings.floodRule>(new Date).getTime())return this._notify("danger",this.lang.floodRule),this._disableInputs(!1),!1;var t=this._similarText(e,this.lastMessage.text,1);return t>this.settings.spamRule?(this._notify("danger",this.lang.spamRule),this._disableInputs(!1),!1):0===e.length?(this._notify("danger",this.lang.emptyMessage),this._disableInputs(!1),!1):e.length>this.settings.messageMaxLength?(this._notify("danger",this.lang.messageMaxLength),this._disableInputs(!1),!1):!0},_disableInputs:function(e){e===!0?($(this.dom.inputMessage).attr("disabled",!0).addClass("disabled"),$(this.dom.buttonSend).attr("disabled",!0).addClass("disabled")):($(this.dom.inputMessage).removeAttr("disabled").removeClass("disabled"),$(this.dom.buttonSend).removeAttr("disabled").removeClass("disabled"))},_similarText:function(e,t,a){if(null===e||null===t||"undefined"==typeof e||"undefined"==typeof t)return 0;e+="",t+="";var s,i,n,l,o=0,d=0,r=0,h=e.length,c=t.length;for(r=0,s=0;h>s;s++)for(i=0;c>i;i++){for(n=0;h>s+n&&c>i+n&&e.charAt(s+n)===t.charAt(i+n);n++);n>r&&(r=n,o=s,d=i)}return l=r,l&&(o&&d&&(l+=this._similarText(e.substr(0,o),t.substr(0,d))),h>o+r&&c>d+r&&(l+=this._similarText(e.substr(o+r,h-o-r),t.substr(d+r,c-d-r)))),a?200*l/(h+c):l},_isArray:function(e){return"[object Array]"==Object.prototype.toString.call(e)},_mergeObjects:function(e,t){var a,s,i,n;if("undefined"==typeof t)return t;if("undefined"==typeof e)return e;for(var l in t)if(a=t[l],"object"==typeof a&&null!==a)if(xetaChat._isArray(a)&&a.length)if("object"!=typeof a[0])if(s=e[l]){i={};for(var o=0,d=s.length;d>o;o++)i[s[o]]=!0;for(var r=0,h=a.length;h>r;r++)a[r]in i||s.push(a[r])}else e[l]=a;else{n={},s=e[l];for(var c=0,m=s.length;m>c;c++)n[s[c].id]=s[c];for(var u=0,g=a.length;g>u;u++)a[u].id in n?xetaChat._mergeObjects(n[a[u].id],a[u]):s.push(a[u])}else xetaChat._mergeObjects(e[l],a);else e[l]=a;return e},_notify:function(e,t){$(".top-right").notify({message:{text:t},type:e}).show()},_getBool:function(e){return!!JSON.parse(String(e).toLowerCase())},_getMessageNode:function(e){return null===e?null:document.getElementById("chatboxMessage-"+e)},_getUserNode:function(e){return null===e?null:document.getElementById("chatboxUser-"+e)},_updateUsersCounter:function(e){$(this.dom.userCounter).text(e)},_updateNotice:function(e){$(this.dom.notice).html(this._replaceSmiley(e))},_formatText:function(e){return this._replaceSmiley(this._escapeHTML(e))},_replaceSmiley:function(e){var t=this.smileys;for(var a in t){var s=new RegExp(this._escapeRegExp(t[a].smiley),"gi");e=e.replace(s,t[a].replace)}return e},_escapeHTML:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\'/g,"&#39;")},_escapeRegExp:function(e){return e.replace(/[-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},$(document).ready(function(){$("#chatboxNotice").dblclick(function(e){e.preventDefault(),e.stopPropagation();var t=xetaChat.settings.urlGetNotice;return $.ajax({type:"POST",url:t,dataType:"json",success:function(e){$("#noticeModal").length&&($("#noticeBox").val(e.notice),CKEDITOR.replace("noticeBox",{customConfig:"config/chat/notice.js"}),$("#noticeModal").modal("show"))},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToEditTheNotice)}}),!1}),$("#noticeForm").submit(function(e){return e.preventDefault(),e.stopPropagation(),$.ajax({type:"POST",url:$(this).attr("action"),dataType:"json",data:{notice:CKEDITOR.instances.noticeBox.getData()},success:function(e){e.error===!1&&$("#noticeModal").modal("hide")},error:function(){xetaChat._notify("danger",xetaChat.lang.errorToEditTheNotice)}}),!1}),$("#noticeModal").on("hide.bs.modal",function(){CKEDITOR.instances.noticeBox.destroy()}),$("#chatboxMessage").keypress(function(e){return e.which&&13==e.which||e.keyCode&&13==e.keyCode?(xetaChat.sendShout(),!1):void 0}),$("#chatboxSend").on("click",function(e){return e.preventDefault(),e.stopPropagation(),xetaChat.sendShout(),!1}),$("#chatboxSmiliePicker").on("click",function(){xetaChat.addSmiliesToBox()}),$("#smiliesBox").on("click",".xeta-smiley",function(){var e=$(this).attr("data-name");return $(xetaChat.dom.inputMessage).insertAroundCaret(" "+xetaChat.smileys[e].smiley,""),!1}),$("#chatboxContent").on("click","#"+xetaChat.domIDs.deleteMessage,function(){var e=$(this).attr("data-id");return xetaChat.deleteMessage(e),!1})}),jQuery.fn.extend({insertAroundCaret:function(e,t){return this.each(function(){if(document.selection)this.focus(),sel=document.selection.createRange(),sel.text=e+sel.text+t,this.focus();else if(this.selectionStart||"0"==this.selectionStart){var a=this.selectionStart,s=this.selectionEnd,i=this.scrollTop;this.value=this.value.substring(0,a)+e+this.value.substring(a,s)+t+this.value.substring(s,this.value.length),this.focus(),this.selectionStart=a+e.length+t.length+(s-a),this.selectionEnd=a+e.length+t.length+(s-a),this.scrollTop=i}else this.value+=e+t,this.focus()})}});